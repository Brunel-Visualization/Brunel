<!DOCTYPE html>

<!--
  ~ Copyright (c) 2015 IBM Corporation and others.
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ You may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<!--
	A sample HTML/JS app that sends data as CSV plus Brunel script to the service
	and renders the results.  The Brunel service produces the JS/CSS which is then executed in the browser using eval().
	A safer route is to generate the required Javascript on the server.

	See:  https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/eval
 -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title><h2></h2>
    </title>
    <meta http-Equiv="Cache-Control" Content="no-cache">
    <meta http-Equiv="Pragma" Content="no-cache">
    <meta http-Equiv="Expires" Content="0">
    <link rel="stylesheet" type="text/css" href="http://www.brunelvis.org/js/brunel.0.7.css" charset="utf-8"></link>
    <link rel="stylesheet" type="text/css" href="http://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css"
          charset="utf-8"></link>
    <link rel="stylesheet" type="text/css" href="http://www.brunelvis.org/js/sumoselect.css" charset="utf-8"></link>

    <!--
        D3 Copyright � 2012, Michael Bostock
        jQuery Copyright � 2010 by The jQuery Project
        sumoselect Copyright � 2014 Hemant Negi
     -->
    <script src="http://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js" charset="utf-8"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.2.js" charset="utf-8"></script>
    <script src="http://code.jquery.com/ui/1.11.4/jquery-ui.js" charset="utf-8"></script>
    <script src="http://www.brunelvis.org/js/brunel.0.7.min.js" charset="utf-8"></script>
    <script src="http://www.brunelvis.org/js/brunel.controls.0.7.min.js" charset="utf-8"></script>
</head>

<body style="margin:0">
<h2>Brunel Javascript Demo</h2>
The content on this page is dynamically generated by the Brunel service.
<P>

    <!-- The SVG that holds the visualization (D3) -->
    <svg id="visualization" width="375" height="375"></svg>

    <!-- A place to put any controls  -->
<div id="controls" class="brunel"/>

</body>

<script>

    var styleElement;               // Element to put our custom Brunel styles into
    //Dynamically sets the CSS for use by the Brunel visualization
    function setCSS(css) {
        if (!styleElement) {
            styleElement = document.createElement("style");
            document.getElementsByTagName("head")[0].appendChild(styleElement);
        }
        styleElement.innerHTML = css;
    }

    //Dynamically load JS given the brunel and the data as CSV
    function loadBrunelJS(brunel_src, width, height, visid, csv) {

        var queryParam = {
            src: brunel_src,	//Brunel script
            width: width,		//Output width
            height: height,		//Output height
            visid: visid		//id for <svg> tag
        };

        var url = "https://brunel.mybluemix.net/brunel/interpret/d3?" + $.param(queryParam);

        $.ajax({
            type: "POST",
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'text/plain'
            },
            data: csv,	          //The data as CSV
            url: url,
            success: function (result) {
                execBrunel(result);
            },
            error: function (xhr, textStatus, errorThrown) {
                console.log(xhr.responseText);
            }
        });
    }

    //Execute the returned Javascript and set the CSS that Brunel requires
    function execBrunel(brunelJSON) {
        setCSS(brunelJSON.css);
        eval(brunelJSON.js);

    }

    //Define data (CSV) and brunel
    var data = "Region,Value\n" +
            "West,10\n" +
            "West,20\n" +
            "East,22\n" +
            "East,2\n" +
            "East,10\n" +
            "North,25";
    var brunel = "bar x(Region) y(Value) mean(Value) style('fill:red') filter(Region)";

    //Go
    loadBrunelJS(brunel, 600, 600, "visualization", data);

</script>
</html>
